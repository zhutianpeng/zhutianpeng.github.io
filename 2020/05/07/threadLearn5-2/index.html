<!DOCTYPE html>
<html lang="zh-cn">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="多线程与高并发（五）JUC同步工具(2)"/><meta name="keywords" content="java, Ztxpp's Blog" /><link rel="alternate" href="/default" title="Ztxpp's Blog" ><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0" />
<link rel="canonical" href="zhutianpeng.github.io/2020/05/07/threadLearn5-2/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" /><link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true,"latex":false};
</script>

    <title>多线程与高并发（五）JUC同步工具(2) - Ztxpp's Blog</title>
  <meta name="generator" content="Hexo 5.1.1"></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Ztxpp's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">首页
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">归档
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签
          </li>
      </a><a href="/Base/">
        <li class="mobile-menu-item">文档
          </li>
      </a><a href="/life/">
        <li class="mobile-menu-item">生活
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Ztxpp's Blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            首页
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            归档
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            标签
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/Base/">
            文档
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/life/">
            生活
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">多线程与高并发（五）JUC同步工具(2)
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2020-05-07
        </span></div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Phaser-%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%A0%85%E6%A0%8F"><span class="toc-text">Phaser - 多阶段栅栏</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%B3%95%EF%BC%9A"><span class="toc-text">用法：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E4%BE%8B%EF%BC%9A"><span class="toc-text">用例：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ReadWriteLock-%E8%AF%BB%E5%86%99%E9%94%81"><span class="toc-text">ReadWriteLock - 读写锁</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%81%E7%9A%84%E7%89%B9%E6%80%A7"><span class="toc-text">锁的特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%B3%95"><span class="toc-text">用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ReadWriteLock%E6%8E%A5%E5%8F%A3%EF%BC%9A"><span class="toc-text">ReadWriteLock接口：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReentrantReadWriteLock-%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-text">ReentrantReadWriteLock 实现类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E4%BE%8B"><span class="toc-text">用例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#semaphore-%E9%99%90%E6%B5%81%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="toc-text">semaphore - 限流信号量</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%B3%95%EF%BC%9A-1"><span class="toc-text">用法：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%99%A8%E4%B8%8E%E6%8E%A5%E5%8F%A3%E7%94%B3%E6%98%8E"><span class="toc-text">构造器与接口申明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E4%BE%8B%EF%BC%9A-1"><span class="toc-text">用例：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exchanger-%E4%BA%A4%E6%8D%A2%E5%99%A8"><span class="toc-text">Exchanger - 交换器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%B3%95-1"><span class="toc-text">用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E4%BE%8B-1"><span class="toc-text">用例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99%EF%BC%9A"><span class="toc-text">参考资料：</span></a></li></ol>
    </div>
  </div><div class="post-content"><blockquote>
<p>多线程与高并发 的系列学习笔记，不仅仅停留在理论层面，尽量落到实地，以代码的形式实践、总结。</p>
</blockquote>
<p>（五）JUC同步工具（2）</p>
<p>对于JUC同步工具的学习思路，首先从用法开始了解，之后再探讨原理。本文主要关注各同步工具的用法，后续文章逐渐深入原理。本文讨论的JUC同步工具包括：</p>
<ul>
<li>ReentrantLock</li>
<li>CountDownLatch</li>
<li>CyclicBarrier</li>
<li><code>Phaser</code></li>
<li><code>ReadWriteLock</code></li>
<li><code>Semaphore</code></li>
<li><code>Exchanger</code></li>
</ul>
<h1 id="Phaser-多阶段栅栏"><a href="#Phaser-多阶段栅栏" class="headerlink" title="Phaser - 多阶段栅栏"></a>Phaser - 多阶段栅栏</h1><h2 id="用法："><a href="#用法：" class="headerlink" title="用法："></a>用法：</h2><ul>
<li><code>Phaser</code>的功能与 CyclicBarrier和CountDownLatch有些类似，类似于一个多阶段的栅栏。是比较复杂的一种同步器。</li>
<li><code>Phaser</code>中的一些概念：<ul>
<li>phase（阶段）：栅栏的名称叫做phase，在任意时间点，Phaser只处于某一个phase(阶段)，初始阶段为0，最大达到Integerr.MAX_VALUE，然后再次归零。当所有parties参与者都到达后，phase值会递增。</li>
<li>parties(参与者)：CyclicBarrier中的参与者在初始构造指定后就不能变更，而Phaser既可以在初始构造时指定参与者的数量，也可以中途通过register、bulkRegister、arriveAndDeregister等方法注册/注销参与者。</li>
<li>unarrive(未到达) / arrive(到达) / advance(进阶)：<ul>
<li>Phaser注册完parties（参与者）之后，参与者的初始状态是unarrived</li>
<li>当某个参与者到达（arrive）当前阶段（phase）后，该参与者状态就会变成arrived</li>
<li>当阶段的到达参与者数满足条件后（注册的数量等于到达的数量），阶段就会发生进阶（advance）——也就是phase值+1。</li>
</ul>
</li>
</ul>
</li>
<li>比较：</li>
</ul>
<table>
<thead>
<tr>
<th align="left">同步器</th>
<th align="left">特点</th>
<th align="left">用法</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CountDownLatch</td>
<td align="left">倒数门栓</td>
<td align="left">初始时设定参与者个数，参与线程执行到<code>await</code>方法时等待。当计数器归零时，所有待线程放行;</td>
</tr>
<tr>
<td align="left">CyclicBarrier</td>
<td align="left">循环栅栏</td>
<td align="left">当参与者线程到达<code>await</code>方法时等待。当到达线程数满足<code>parties</code>个数时放行。与数门栓相比，可以循环使用。</td>
</tr>
<tr>
<td align="left">Phaser</td>
<td align="left">多阶段栅栏</td>
<td align="left">可以在初始时设定参与线程数，也可以中途注册/注销参与者，当到达的参与者数量满足栅栏设的数量后，会进行阶段升级</td>
</tr>
</tbody></table>
<h2 id="用例："><a href="#用例：" class="headerlink" title="用例："></a>用例：</h2><p>本例使用<code>Phaser</code>来管理多线程的几个阶段。7个人（5个参与者线程，1个新郎线程，1个新娘线程）参与一项婚礼，分为4个步骤进行：到场，吃饭，离开，洞房。要求是所有线程全部完成某一阶段，才能进入下一阶段。（相当于分阶段控制）；而且不同的阶段，还能按照不同的参与者的身份进行控制（洞房阶段只有新郎新娘两人参与，其他人不能参与）。下面是具体的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T4_Phaser</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">static</span> MarriagePhaser phaser = <span class="keyword">new</span> MarriagePhaser();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">milliSleep</span><span class="params">(<span class="keyword">int</span> milli)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(milli);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        phaser.bulkRegister(<span class="number">7</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Person(<span class="string">&quot;p&quot;</span>+i)).start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Person(<span class="string">&quot;新郎&quot;</span>)).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Person(<span class="string">&quot;新娘&quot;</span>)).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MarriagePhaser</span> <span class="keyword">extends</span> <span class="title">Phaser</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*  Override了onAdvance：</span></span><br><span class="line"><span class="comment">        最后一个参与者到达时，会触发onAdvance方法,</span></span><br><span class="line"><span class="comment">        相当于CyclicBarrier中的barrierAction任务。*/</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onAdvance</span><span class="params">(<span class="keyword">int</span> phaser, <span class="keyword">int</span> registerParties)</span></span>&#123;</span><br><span class="line">            <span class="keyword">switch</span>(phaser)&#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                    System.out.println(<span class="string">&quot;所有人到齐了，人数：&quot;</span>+registerParties);</span><br><span class="line">                    System.out.println();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    System.out.println(<span class="string">&quot;所有人都吃完了，人数：&quot;</span>+registerParties);</span><br><span class="line">                    System.out.println();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    System.out.println(<span class="string">&quot;所有人都离开了，人数：&quot;</span>+ registerParties);</span><br><span class="line">                    System.out.println();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                    System.out.println(<span class="string">&quot;婚礼结束，新郎新娘抱抱。人数：&quot;</span>+ registerParties);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        String name;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">arrive</span><span class="params">()</span></span>&#123;</span><br><span class="line">            milliSleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">            System.out.printf(<span class="string">&quot;%s 到达现场 \n&quot;</span>, name);</span><br><span class="line">            phaser.arriveAndAwaitAdvance(); <span class="comment">// 等待其它参与者线程到达</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>&#123;</span><br><span class="line">            milliSleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">            System.out.printf(<span class="string">&quot;%s 吃完 \n&quot;</span>,name);</span><br><span class="line">            phaser.arriveAndAwaitAdvance(); <span class="comment">// 等待其它参与者线程到达</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">leave</span><span class="params">()</span></span>&#123;</span><br><span class="line">            milliSleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">            System.out.printf(<span class="string">&quot;%s 离开 \n&quot;</span>,name);</span><br><span class="line">            phaser.arriveAndAwaitAdvance(); <span class="comment">// 等待其它参与者线程到达</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hug</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(name.equals(<span class="string">&quot;新郎&quot;</span>)||name.equals(<span class="string">&quot;新娘&quot;</span>))&#123;</span><br><span class="line">                milliSleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">                System.out.printf(<span class="string">&quot;%s 洞房 \n&quot;</span>,name);</span><br><span class="line">                phaser.arriveAndAwaitAdvance(); <span class="comment">// 等待其它参与者线程到达</span></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                phaser.arriveAndDeregister();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            arrive();;</span><br><span class="line">            eat();</span><br><span class="line">            leave();</span><br><span class="line">            hug();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<details>
<summary>输出</summary>
<pre>
p1 到达现场 
新郎 到达现场 
p4 到达现场 
p3 到达现场 
新娘 到达现场 
p0 到达现场 
p2 到达现场 
所有人到齐了，人数：7

<p>新郎 吃完<br>p1 吃完<br>新娘 吃完<br>p0 吃完<br>p3 吃完<br>p4 吃完<br>p2 吃完<br>所有人都吃完了，人数：7</p>
<p>新娘 离开<br>p2 离开<br>p4 离开<br>p1 离开<br>新郎 离开<br>p3 离开<br>p0 离开<br>所有人都离开了，人数：7 </p>
<p>新郎 洞房<br>新娘 洞房<br>婚礼结束，新郎新娘抱抱。人数：2<br></pre></p>
</details>

<h1 id="ReadWriteLock-读写锁"><a href="#ReadWriteLock-读写锁" class="headerlink" title="ReadWriteLock - 读写锁"></a>ReadWriteLock - 读写锁</h1><h2 id="锁的特性"><a href="#锁的特性" class="headerlink" title="锁的特性"></a>锁的特性</h2><ul>
<li>可重入(Reentrant)：<code>synchronized</code>和<code>ReentrantLock</code>具有可重入性</li>
<li>可中断/不可中断：<code>synchronized</code>不可中断，<code>Lock</code>接口可中断</li>
<li>公平/非公平：<code>synchronized</code>是非公平锁。<code>ReentrantLock</code>和<code>ReentrantReadWriteLock</code>，在默认情况下是非公平锁，可以设置为公平锁。</li>
<li>读写锁/互斥锁：为了解决锁的互斥与共享引入的概念。<code>synchronized</code>获取锁的线程一律互斥。<code>ReentrantReadWriteLock</code>具有读与读之间共享的特点。</li>
</ul>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><h3 id="ReadWriteLock接口："><a href="#ReadWriteLock接口：" class="headerlink" title="ReadWriteLock接口："></a>ReadWriteLock接口：</h3><ul>
<li><p>定义：ReadWriteLock接口是一个单独的接口（未继承Lock接口），该接口提供了获取读锁和写锁的方法: <code>readLock()</code>和<code>writeLock()</code>。</p>
</li>
<li><p>特点：</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">读锁</th>
<th align="center">写锁</th>
</tr>
</thead>
<tbody><tr>
<td align="center">读锁</td>
<td align="center">非阻塞</td>
<td align="center">阻塞</td>
</tr>
<tr>
<td align="center">写锁</td>
<td align="center">阻塞</td>
<td align="center">阻塞</td>
</tr>
</tbody></table>
<ul>
<li>使用场景：读多写少、读较为耗时</li>
</ul>
<h3 id="ReentrantReadWriteLock-实现类"><a href="#ReentrantReadWriteLock-实现类" class="headerlink" title="ReentrantReadWriteLock 实现类"></a>ReentrantReadWriteLock 实现类</h3><ul>
<li><p>定义： ReentrantReadWriteLock类是通过定义内部类实现AQS框架的API来实现独占/共享的功能。从而实现ReadWriteLock接口。</p>
</li>
<li><p>特点：</p>
<ul>
<li>支持公平/非公平策略</li>
<li>支持锁重入<ul>
<li>同一读线程在获取了读锁后还可以获取读锁；</li>
<li>同一写线程在获取了写锁之后既可以再次获取写锁又可以获取读锁；</li>
</ul>
</li>
<li>支持锁降级<ul>
<li>先获取写锁，然后获取读锁，最后释放写锁，这样写锁就降级成了读锁。</li>
<li>但是，读锁不能升级到写锁。</li>
</ul>
</li>
<li>Condition条件支持</li>
</ul>
</li>
</ul>
<h2 id="用例"><a href="#用例" class="headerlink" title="用例"></a>用例</h2><p>本例中，主要比较读写锁与互斥锁的执行效率：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T5_ReadWriteLock</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> value;</span><br><span class="line">    <span class="comment">// 1. 直接使用互斥锁</span></span><br><span class="line">    <span class="keyword">static</span> Lock lock = <span class="keyword">new</span> ReentrantLock(); </span><br><span class="line">    <span class="comment">// 2. 使用读写锁</span></span><br><span class="line">    <span class="keyword">static</span> ReadWriteLock readWriteLock = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">    <span class="keyword">static</span> Lock readLock = readWriteLock.readLock();</span><br><span class="line">    <span class="keyword">static</span> Lock writeLock = readWriteLock.writeLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(Lock lock)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;read over, value=&quot;</span>+value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(Lock lock, <span class="keyword">int</span> v)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            value = v;</span><br><span class="line">            System.out.println(<span class="string">&quot;write over, set value to: &quot;</span>+value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1. 直接使用互斥锁</span></span><br><span class="line">        <span class="comment">// Runnable readR = ()-&gt;read(lock);</span></span><br><span class="line">        <span class="comment">// Runnable writeR = ()-&gt;write(lock,new Random().nextInt());</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 使用读写锁</span></span><br><span class="line">        Runnable readR = ()-&gt;read(readLock);</span><br><span class="line">        Runnable writeR = ()-&gt;write(writeLock,<span class="keyword">new</span> Random().nextInt());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) <span class="keyword">new</span> Thread(writeR).start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">18</span>; i++) <span class="keyword">new</span> Thread(readR).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效率比较：</p>
<p>使用读写锁效率更高，18个读线程可以在1秒完成，另外两个写线程各占1秒；使用互斥锁，所有线程相互互斥，各占1秒，一般需要20秒完成。读写锁在这个应用场景中，效率更高。</p>
<h1 id="semaphore-限流信号量"><a href="#semaphore-限流信号量" class="headerlink" title="semaphore - 限流信号量"></a>semaphore - 限流信号量</h1><h2 id="用法：-1"><a href="#用法：-1" class="headerlink" title="用法："></a>用法：</h2><ul>
<li>读音： [ˈseməfɔːr] </li>
<li>Semaphore维护了一个许可集，其实就是一定数量的“许可证”。</li>
<li>当有线程想要访问共享资源时，需要先获取(acquire)的许可；如果许可不够了，线程需要一直等待，直到许可可用。当线程使用完共享资源后，可以归还(release)许可，以供其它需要的线程使用。</li>
<li>另外，Semaphore支持公平/非公平策略，这和ReentrantLock类似</li>
</ul>
<h2 id="构造器与接口申明"><a href="#构造器与接口申明" class="headerlink" title="构造器与接口申明"></a>构造器与接口申明</h2><ul>
<li>构造器：  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个包含permits个许可令的、非公平（默认）的信号量</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Semaphore</span><span class="params">(<span class="keyword">int</span> permits)</span></span>&#123;&#125;</span><br><span class="line"><span class="comment">// 创建一个包含permits个许可令的、公平/非公平的信号量</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Semaphore</span><span class="params">(<span class="keyword">int</span> permits, <span class="keyword">boolean</span> fair)</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure></li>
<li>常用接口申明： <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取令牌</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">acquire</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> permits)</span></span></span><br><span class="line"><span class="function"><span class="comment">//释放令牌</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">release</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="用例：-1"><a href="#用例：-1" class="headerlink" title="用例："></a>用例：</h2><p>本例可以看出<code>Semaphore</code>具有限流的作用。当然了，当初始化为1时可以当做锁来用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T6_Semaphore</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Semaphore s = <span class="keyword">new</span> Semaphore(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                s.acquire();</span><br><span class="line">                System.out.println(<span class="string">&quot;t1 is running...&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">200</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;t1 is running...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                s.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                s.acquire();</span><br><span class="line">                System.out.println(<span class="string">&quot;t2 is running...&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">200</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;t2 is running...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                s.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Exchanger-交换器"><a href="#Exchanger-交换器" class="headerlink" title="Exchanger - 交换器"></a>Exchanger - 交换器</h1><h2 id="用法-1"><a href="#用法-1" class="headerlink" title="用法"></a>用法</h2><ul>
<li>这个类主要作用是两个线程之间的交换数据。</li>
<li>先到的线程会阻塞等待后到的线程，交换完数据后，再同时放行。</li>
<li>应用:游戏中交换装备、可以实现简单的生产者-消费者模式。</li>
</ul>
<h2 id="用例-1"><a href="#用例-1" class="headerlink" title="用例"></a>用例</h2><p>本例可以看出，先到的线程会阻塞等待后到的线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T7_Exchanger</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            String s = <span class="string">&quot;T1&quot;</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;t1 begins running&quot;</span>);</span><br><span class="line">                s = exchanger.exchange(s);</span><br><span class="line">                System.out.println(<span class="string">&quot;t1 continue runs&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot; &quot;</span>+s);</span><br><span class="line">        &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;main threads sleep&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            String s = <span class="string">&quot;T2&quot;</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;t2 begins running...&quot;</span>);</span><br><span class="line">                s = exchanger.exchange(s);</span><br><span class="line">                System.out.println(<span class="string">&quot;t2 continue runs.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot; &quot;</span>+s);</span><br><span class="line">        &#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<details>
<summary>输出</summary>
<pre>
t1 begins running
main threads sleep
t2 begins running...
t2 continue runs.
t1 continue runs
t2 T1
t1 T2
</pre>
</details>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li><p>ReentrantLock： 可重入锁</p>
<ul>
<li><code>lock.tryLock()</code></li>
<li><code>lock.lockInterruptibly()</code></li>
<li>可设置“公平/非公平”</li>
</ul>
</li>
<li><p>CountDownLatch： 倒数门栓</p>
<ul>
<li><code>await()</code> + <code>countDown()</code></li>
</ul>
</li>
<li><p>CyclicBarrier - 循环栅栏</p>
<ul>
<li><code>CyclicBarrier(int parties, Runnable barrierAction)</code> + <code>await()</code></li>
</ul>
</li>
<li><p>Phaser - 多阶段的栅栏</p>
<ul>
<li>参与者个数可变，达到数量后会进行阶段升级</li>
<li><code>bulkRegister(int x)</code> + <code>arriveAndAwaitAdvance()</code> or <code>arriveAndDeregister()</code></li>
</ul>
</li>
<li><p>ReadWriteLock - 读写锁</p>
<ul>
<li>读写锁 与 互斥锁的 概念</li>
<li>实现类<code>ReentrantReadWriteLock</code>的特点</li>
</ul>
</li>
<li><p>Semophare - 限流信号量</p>
<ul>
<li><code>acquire()</code> + <code>release()</code></li>
</ul>
</li>
<li><p>Exchanger - 交换器</p>
<ul>
<li>两个线程之间的阻塞交换</li>
<li><code>exchanger(V x)</code></li>
</ul>
</li>
</ul>
<h1 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h1><ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000015558984">透彻理解Java并发编程系列</a></li>
</ul>
<blockquote>
<p>后记：本着先实践后原理的原则，JUC同步工具（1）、（2）两文，不求甚解的把所有的J.U.C同步工具列举出来，重点放在了用法和用例上。后面的文章，会在几道题目中加深理解。对于其原理，这些同步工具大都是使用了AQS进行实现，后面会就AQS的源码和其数据结构进行分析。</p>
</blockquote>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="zhutianpeng.github.io">zhutianpeng</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="zhutianpeng.github.io/2020/05/07/threadLearn5-2/">zhutianpeng.github.io/2020/05/07/threadLearn5-2/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/java/">java</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/2020/05/09/threadLearn6/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">多线程与高并发（六）Wait-Notify与LockSupport</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    <a class="next" href="/2020/05/06/threadLearn5/">
        <span class="next-text nav-default">多线程与高并发（五）JUC同步工具(1)</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
        <a target="_blank" rel="noopener" href="https://github.com/ahonn" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2022<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">zhutianpeng</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
